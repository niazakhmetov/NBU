<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ L.nav_verify_title }} | TengeHub</title>
    <link rel="stylesheet" href="styles/main.css">
    <style>
        /* Стиль для блока QR-кода (похож на .card, но с фиксированным расположением элементов) */
        .qr-box {
            display: flex; 
            align-items: flex-start;
            gap: 20px;
            padding: 20px; 
            border: 1px solid var(--color-border); 
            border-radius: var(--border-radius);
            margin-bottom: 30px; 
            background-color: var(--color-background-card);
        }
        .qr-image-wrapper {
            /* Строгая граница для QR-кода */
            border: 1px solid var(--color-border-dark); 
            padding: 5px;
            flex-shrink: 0;
            background-color: var(--color-background-default);
        }
        .qr-image {
            width: 150px; 
            height: 150px; 
            display: block;
        }
        /* Сохраняем стили для статуса, если они не полностью перекрываются в main.css */
        .verification-result {
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        /* Используем классы статуса из main.css (.change-up, .change-down) для .verification-result, 
           а остальные классы переопределяем для соответствия цветовой палитре. */
        .status-checking { background-color: var(--color-status-warn); color: var(--color-text-dark); }
        .status-success { background-color: var(--color-status-up); color: var(--color-text-light); }
        .status-error { background-color: var(--color-status-down); color: var(--color-text-light); }
    </style>
</head>
<body>
    
    {# =================================================================
       1. ШАПКА И НАВИГАЦИЯ (Использование классов .navbar и .logo)
       ================================================================= #}
    <header>
        <div class="container navbar">
            <div class="logo">TengeHub</div> 
            
            <nav>
                <a href="index.html">{{ L.nav_main }}</a>
                <a href="full_rates.html">{{ L.nav_all_rates }}</a>
                <a href="about.html">{{ L.nav_about }}</a>
                <a href="status.html">{{ L.nav_status | default('Статус') }}</a> 
            </nav>
            <div></div>
        </div>
    </header>
    
    {# =================================================================
       2. ОСНОВНОЙ КОНТЕНТ (Использование класса .container)
       ================================================================= #}
    <div class="container">
        
        <h1 style="text-align: center; margin-bottom: 30px;">{{ L.verify_h2 | default('Подтверждение данных') }}</h1>

        {# --- БЛОК QR-КОДА (Строгий дизайн) --- #}
        <section class="qr-box">
            
            <div class="qr-image-wrapper">
                <img 
                    {# Передача Base64-строки для отображения QR-кода #}
                    src="data:image/png;base64,{{ global_qr_code_base64 }}" 
                    alt="QR Code для верификации курсов" 
                    class="qr-image"
                >
                <p style="text-align: center; font-size: 0.85em; margin-top: 5px; color: var(--color-text-secondary);">
                    QR-код для верификации
                </p>
            </div>

            <div>
                <h2 style="margin-top: 0; color: var(--color-brand-primary);">
                    {{ L.verify_callout_h2 | default('Официальное подтверждение курсов') }}
                </h2>
                <p style="color: var(--color-text-primary);">
                    Для целей бухгалтерского и налогового учета: Моментальная верификация данных с официальным источником НБ РК.
                </p>
                <p style="font-weight: bold;">
                    Отсканируйте QR-код для подтверждения актуальности курсов на <span style="color: var(--color-brand-secondary);">{{ course_date }}</span>.
                </p>
            </div>
        </section>

        {# --- БЛОК СТАТУСА ВЕРИФИКАЦИИ (Динамический, управляется JS) --- #}
        <div id="verification-status" class="verification-result status-checking">
            {{ L.verify_status_checking | default('Идет проверка данных с Национальным Банком РК...') }}
        </div>
        
        {# --- ТАБЛИЦА ВЕРИФИКАЦИОННЫХ ДЕТАЛЕЙ (Использование .data-table) --- #}
        <section class="card" style="padding: 0; margin-top: 40px;">
            <table class="data-table">
                <tbody>
                    <tr>
                        <th style="text-align: left;">{{ L.verify_source | default('Официальный источник') }}</th>
                        <td id="data-source">Национальный Банк Республики Казахстан (НБ РК)</td>
                    </tr>
                    <tr>
                        <th style="text-align: left;">{{ L.verify_date | default('Запрошенная дата курсов') }}</th>
                        <td id="verify-date">...</td>
                    </tr>
                    <tr>
                        <th style="text-align: left;">{{ L.verify_code | default('Проверяемый код валюты') }}</th>
                        <td id="verify-code">...</td>
                    </tr>
                    <tr>
                        <th style="text-align: left;">{{ L.verify_rate | default('Курс, полученный от НБ РК') }}</th>
                        <td id="verify-rate" style="font-weight: bold; color: var(--color-brand-secondary);">...</td>
                    </tr>
                </tbody>
            </table>
        </section>
        
        <p class="disclaimer" style="text-align: center; margin-top: 40px; color: var(--color-text-secondary);">
            {{ L.verify_disclaimer | default('Вся информация, полученная в результате верификации, основывается на данных, предоставляемых официальным API Национального Банка РК в реальном времени.') }}
        </p>
    </div>
    
    {# =================================================================
       3. НИЖНИЙ ФУТЕР (Минималистичный шаблон)
       ================================================================= #}
    <footer>
        <div class="container footer-minimal-content">
            <p class="footer-source-text">
                &copy; {{ now().strftime('%Y') | default('2025') }} TengeHub. 
                <span class="source-info">{{ L.footer_data_source | default('Данные получены с официального SOAP-сервиса Национального Банка РК.') }}</span>
            </p>
        </div>
    </footer>
    
    {# =================================================================
       4. JS ДЛЯ ВЕРИФИКАЦИИ (Функционал сохранен)
       ================================================================= #}
    <script>
        const NBK_API_URL = "https://nationalbank.kz/rss/get_rates.cfm"; 
        
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('d'); 
        const codeParam = urlParams.get('c'); 
        const langCode = '{{ L.language_code | default("ru") }}'; 

        const statusElement = document.getElementById('verification-status');
        const dateElement = document.getElementById('verify-date');
        const codeElement = document.getElementById('verify-code');
        const rateElement = document.getElementById('verify-rate');

        // Отображаем полученные параметры
        dateElement.textContent = dateParam || 'N/A';
        codeElement.textContent = codeParam || 'N/A (Проверка всей даты)';
        
        // --- ФУНКЦИЯ ПАРСИНГА XML (упрощенная версия) ---
        function parseXmlAndFindRate(xmlText, currencyCode) {
            let cleanXmlText = xmlText.trim();
            const xmlStart = cleanXmlText.indexOf('<rates>');
            if (xmlStart > 0) {
                cleanXmlText = cleanXmlText.substring(xmlStart);
            }

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(cleanXmlText, "text/xml");
            
            if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                return null;
            }

            const items = xmlDoc.getElementsByTagName('item');
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const code = item.getElementsByTagName('title')[0]?.textContent;
                
                const rateText = item.getElementsByTagName('description')[0]?.textContent;
                
                if (code === currencyCode) {
                    const rate = rateText ? parseFloat(rateText.replace(',', '.')) : null;
                    return rate;
                }
            }

            // Проверка наличия даты в теге <date> (для проверки всей страницы)
            const dateInXml = xmlDoc.getElementsByTagName('date')[0]?.textContent;
            
            if (!currencyCode && dateInXml === dateParam) {
                 return 'DATE_FOUND';
            }
            
            return null; 
        }

        // --- ФУНКЦИЯ ВЕРИФИКАЦИИ ---
        async function verifyRate() {
            if (!dateParam) {
                statusElement.className = 'verification-result status-error';
                statusElement.textContent = '{{ L.verify_status_error }} (Отсутствует параметр даты)';
                return;
            }

            try {
                // Запрос к НБ РК
                const response = await fetch(`${NBK_API_URL}?fdate=${dateParam}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }

                const xmlText = await response.text();

                // Проверка на JSON-ошибку (API может вернуть JSON-ошибку вместо XML)
                if (xmlText.trim().startsWith('{') && xmlText.trim().endsWith('}')) {
                    const errorJson = JSON.parse(xmlText);
                    if (errorJson.message) {
                        throw new Error(`API Error: ${errorJson.message}`);
                    }
                }
                
                let foundRate = null;
                
                if (codeParam) {
                    // Проверяем конкретный курс
                    foundRate = parseXmlAndFindRate(xmlText, codeParam);
                } else {
                    // Проверяем, что НБ РК вернул данные на запрошенную дату
                    foundRate = parseXmlAndFindRate(xmlText);
                }

                if (foundRate === 'DATE_FOUND') {
                    // Успешная верификация всей страницы
                    statusElement.className = 'verification-result status-success';
                    statusElement.textContent = '{{ L.verify_status_success | default("Верификация успешна!") }} (Подтверждена актуальность данных на дату)';
                    rateElement.textContent = 'ВСЕ КУРСЫ ПОДТВЕРЖДЕНЫ';
                } else if (typeof foundRate === 'number') {
                    // Успешная верификация конкретного курса
                    statusElement.className = 'verification-result status-success';
                    statusElement.textContent = '{{ L.verify_status_success | default("Верификация успешна!") }}';
                    rateElement.textContent = foundRate.toFixed(4); 
                } else {
                    // Курс не найден
                    statusElement.className = 'verification-result status-error';
                    statusElement.textContent = '{{ L.verify_status_not_found | default("Курс или дата не найдены в официальном источнике.") }}';
                }

            } catch (error) {
                statusElement.className = 'verification-result status-error';
                statusElement.textContent = `{{ L.verify_status_error | default("Произошла ошибка верификации.") }} (Ошибка: ${error.message || 'API или сети'})`;
            }
        }

        // Запуск верификации
        verifyRate();
    </script>
</body>
</html>
