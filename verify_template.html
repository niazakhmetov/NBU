<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ L.nav_verify_title }} | TengeHub</title>
    
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f4f7f9;
            color: #333;
            line-height: 1.6;
        }
        .container {
            width: 90%;
            max-width: 800px;
            margin: 40px auto;
            background: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        header {
            background-color: #007bff;
            color: white;
            padding: 15px 0;
            text-align: center;
            border-radius: 8px 8px 0 0;
            margin-bottom: 20px;
        }
        nav a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            font-weight: bold;
        }
        h1 {
            color: #007bff;
            font-size: 28px;
            text-align: center;
            margin-bottom: 20px;
        }
        /* Стиль для блока QR-кода */
        .qr-box {
            padding: 20px; 
            border: 1px solid #b3e5fc; 
            border-radius: 6px; 
            margin-bottom: 20px; 
            background-color: #e1f5fe; 
            display: flex; 
            align-items: flex-start;
        }
        .qr-image-wrapper {
            margin-right: 20px; 
            border: 1px solid #ccc; 
            padding: 5px;
            flex-shrink: 0;
        }
        .qr-image {
            width: 150px; 
            height: 150px; 
            display: block;
        }
        /* Конец стиля для QR-кода */
        .verification-result {
            padding: 25px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.2em;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .status-checking { background-color: #ffc107; color: #333; }
        .status-success { background-color: #28a745; color: white; }
        .status-error { background-color: #dc3545; color: white; }
        
        .data-table {
            width: 100%;
            border: 1px solid #eee;
            border-radius: 4px;
            border-collapse: collapse; /* Добавлено для лучшего вида */
        }
        .data-table th, .data-table td {
            padding: 12px;
            border-bottom: 1px solid #eee;
        }
        .data-table th {
            width: 40%;
            background-color: #f8f8f8;
            font-weight: bold;
            text-align: right;
        }
        .disclaimer {
            margin-top: 40px;
            padding: 15px;
            border-top: 1px solid #eee;
            font-size: 0.9em;
            color: #666;
            text-align: center;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="index.html">{{ L.nav_main }}</a>
            <a href="full_rates.html">{{ L.nav_all_rates }}</a>
            <a href="about.html">{{ L.nav_about }}</a>
            <a href="status.html">{{ L.nav_status | default('Статус') }}</a> 
        </nav>
    </header>
    
    <div class="container">
        <h1>{{ L.verify_h2 }}</h1>

        {# ⭐ ДОБАВЛЕН БЛОК QR-КОДА (ранее отсутствовал) #}
        <div class="qr-box">
            
            <div class="qr-image-wrapper">
                <img 
                    {# КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Использование Base64-строки с префиксом #}
                    src="data:image/png;base64,{{ global_qr_code_base64 }}" 
                    alt="QR Code для верификации курсов" 
                    class="qr-image"
                >
                <p style="text-align: center; font-size: 0.9em; margin-top: 5px;">QR Code для верификации курсов</p>
            </div>

            <div>
                <p>Для целей бухгалтерского и налогового учета: Моментальная верификация данных с официальным источником НБ РК.</p>
                <p>Отсканируйте QR-код для подтверждения актуальности курсов на <strong>{{ course_date }}</strong>.</p>
                <p>Наведите камеру или сканер для перехода на страницу официального подтверждения.</p>
            </div>
        </div>
        {# КОНЕЦ ДОБАВЛЕННОГО БЛОКА #}

        <div id="verification-status" class="verification-result status-checking">
            {{ L.verify_status_checking }}
        </div>
        
        <table class="data-table">
            <tr>
                <th>{{ L.verify_source }}</th>
                <td id="data-source">Национальный Банк Республики Казахстан (НБ РК)</td>
            </tr>
            <tr>
                <th>{{ L.verify_date }}</th>
                <td id="verify-date">...</td>
            </tr>
            <tr>
                <th>{{ L.verify_code }}</th>
                <td id="verify-code">...</td>
            </tr>
            <tr>
                <th>{{ L.verify_rate }}</th>
                <td id="verify-rate">...</td>
            </tr>
        </table>

        <p class="disclaimer">
            {{ L.verify_disclaimer }}
        </p>
    </div>
    
    <script>
        // Код API-сервиса НБ РК, используемый в data_fetcher.py
        const NBK_API_URL = "https://nationalbank.kz/rss/get_rates.cfm"; 
        
        // Получение параметров из URL
        const urlParams = new URLSearchParams(window.location.search);
        const dateParam = urlParams.get('d'); // Дата (DD.MM.YYYY)
        const codeParam = urlParams.get('c'); // Код валюты (USD, EUR)
        const langCode = '{{ L.language_code | default("ru") }}'; // Код языка для сообщений

        const statusElement = document.getElementById('verification-status');
        const dateElement = document.getElementById('verify-date');
        const codeElement = document.getElementById('verify-code');
        const rateElement = document.getElementById('verify-rate');

        // Отображаем полученные параметры, пока не получим ответ
        dateElement.textContent = dateParam || 'N/A';
        codeElement.textContent = codeParam || 'N/A (Проверка всей даты)';
        
        // --- ФУНКЦИЯ ПАРСИНГА XML (упрощенная версия data_parser.py для JS) ---
        function parseXmlAndFindRate(xmlText, currencyCode) {
            // ⭐ КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Удаление преамбулы перед парсингом XML
            let cleanXmlText = xmlText.trim();
            const xmlStart = cleanXmlText.indexOf('<rates>');
            if (xmlStart > 0) {
                cleanXmlText = cleanXmlText.substring(xmlStart);
            }

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(cleanXmlText, "text/xml");
            
            // Проверка на ошибку парсинга
            if (xmlDoc.getElementsByTagName("parsererror").length > 0) {
                console.error("XML Parse Error:", xmlDoc.getElementsByTagName("parsererror")[0].textContent);
                return null;
            }

            const items = xmlDoc.getElementsByTagName('item');
            
            for (let i = 0; i < items.length; i++) {
                const item = items[i];
                const code = item.getElementsByTagName('title')[0]?.textContent;
                
                const rateText = item.getElementsByTagName('description')[0]?.textContent;
                
                if (code === currencyCode) {
                    // Замена запятой на точку и парсинг числа
                    const rate = rateText ? parseFloat(rateText.replace(',', '.')) : null;
                    return rate;
                }
            }

            // Проверка наличия даты в теге <date> (согласно структуре XML)
            const dateElement = xmlDoc.getElementsByTagName('date')[0]?.textContent;
            
            if (!currencyCode && dateElement === dateParam) {
                 return 'DATE_FOUND';
            }
            
            return null; // Курс или дата не найдены
        }


        // --- ФУНКЦИЯ ВЕРИФИКАЦИИ ---
        async function verifyRate() {
            if (!dateParam) {
                statusElement.className = 'verification-result status-error';
                statusElement.textContent = '{{ L.verify_status_error }} (Отсутствует параметр даты)';
                return;
            }

            try {
                // Выполняем запрос к НБ РК с датой (API требует fdate)
                const response = await fetch(`${NBK_API_URL}?fdate=${dateParam}`);
                
                if (!response.ok) {
                    throw new Error(`HTTP Error: ${response.status}`);
                }

                const xmlText = await response.text();

                // ⭐ КРИТИЧЕСКОЕ ИСПРАВЛЕНИЕ: Проверка на JSON-ошибку (как в data_fetcher.py)
                if (xmlText.trim().startsWith('{') && xmlText.trim().endsWith('}')) {
                    const errorJson = JSON.parse(xmlText);
                    if (errorJson.message) {
                        throw new Error(`API Error: ${errorJson.message}`);
                    }
                }
                
                let foundRate = null;
                
                if (codeParam) {
                    // Проверяем конкретный курс
                    foundRate = parseXmlAndFindRate(xmlText, codeParam);
                } else {
                    // Проверяем, что НБ РК вернул данные на запрошенную дату (проверка всей страницы)
                    foundRate = parseXmlAndFindRate(xmlText);
                }

                if (foundRate === 'DATE_FOUND') {
                    // Успешная верификация всей страницы
                    statusElement.className = 'verification-result status-success';
                    statusElement.textContent = '{{ L.verify_status_success }} (Подтверждена актуальность данных на дату)';
                    rateElement.textContent = 'ВСЕ КУРСЫ ПОДТВЕРЖДЕНЫ';
                } else if (typeof foundRate === 'number') {
                    // Успешная верификация конкретного курса
                    statusElement.className = 'verification-result status-success';
                    statusElement.textContent = '{{ L.verify_status_success }}';
                    rateElement.textContent = foundRate.toFixed(4); // Форматируем для отображения
                } else {
                    // Курс не найден в ответе API
                    statusElement.className = 'verification-result status-error';
                    statusElement.textContent = '{{ L.verify_status_not_found }}';
                }

            } catch (error) {
                console.error("Verification failed:", error);
                statusElement.className = 'verification-result status-error';
                statusElement.textContent = `{{ L.verify_status_error }} (Ошибка: ${error.message || 'API или сети'})`;
            }
        }

        // Запуск верификации при загрузке страницы
        verifyRate();
    </script>
</body>
</html>
